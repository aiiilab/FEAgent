# Stereo Vision Fish Measurement System

A binocular stereo vision system for measuring live fish body length in aquaculture tanks without manual handling. Two cameras observe the same fish from slightly different positions; by identifying the same anatomical points (mouth tip and caudal base) in both views, the system triangulates 3D coordinates and computes the true physical length in millimeters — regardless of the fish's distance from the camera.

## How It Works

1. **Two cameras** are mounted side by side facing the tank glass, recording synchronized video.
2. **Stereo calibration** using a checkerboard pattern determines each camera's intrinsic parameters (focal length, distortion) and the geometric relationship between the two cameras (baseline, rotation).
3. **Rectification** warps both images so that corresponding points lie on the same horizontal scanline (epipolar constraint).
4. **Measurement** uses the disparity (horizontal pixel shift) between left and right views to compute depth via `Z = f × B / disparity`, then reconstructs 3D coordinates and calculates the Euclidean distance between mouth and caudal base.

The system achieves sub-millimeter disparity precision on DCI 4K video (4096×2160) with a ~176mm baseline, yielding depth resolution of approximately 1-2mm at typical working distances (600-1000mm).

---

## Module Contents

### Scripts

| File | Purpose |
|------|---------|
| `prepare.py` | **Data preparation**: audio-based video synchronization (2 or 3 cameras), calibration frame extraction |
| `main.py` | **Stereo engine**: checkerboard calibration, rectification verification, interactive manual measurement |

### prepare.py Commands

| Command | Description |
|---------|-------------|
| `sync` | Synchronize 2-3 videos using audio cross-correlation. Aligns heads to a common start time and trims tails to the shortest duration. |
| `extract` | Extract calibration frames from checkerboard video at a configurable frame rate (default: 1 fps). |
| `prepare` | Full pipeline: sync fish videos + sync calibration videos + extract frames + generate config. |

### main.py Commands

| Command | Description |
|---------|-------------|
| `calibrate` | Detect checkerboard corners in paired images, compute intrinsic/extrinsic parameters, generate rectification maps. Outputs `calib_params.npz`. |
| `verify` | Display rectified left/right images side by side with horizontal lines to visually confirm epipolar alignment. |
| `measure` | Interactive GUI: navigate video frames, click fish mouth + caudal base in both left and right views, compute 3D length. Outputs `measurements.json`. |

---

## Data Directory Structure

All data for a single recording session lives in one folder. Raw videos go at the top level with standardized names. All generated files are placed in subdirectories automatically.

```
session_MMDD/
│
│── left.MP4                 # Raw left camera video (rename from camera filename)
│── right.MP4                # Raw right camera video (rename from camera filename)
│── side.MOV                 # Raw side camera video (optional, for ground truth)
│
│── main.py                  # Copy or symlink
│── prepare.py               # Copy or symlink
│── run_pipeline.bat          # Optional batch orchestrator (Windows)
│
│── synced/                   # Generated by: prepare.py sync
│   │── left_synced.mp4       #   Audio-aligned left video
│   │── right_synced.mp4      #   Audio-aligned right video
│   │── side_synced.mp4       #   Audio-aligned side video
│   │── left_calib.mp4        #   Calibration segment (cut by user)
│   │── right_calib.mp4       #   Calibration segment (cut by user)
│   │── left_fish.mp4         #   Fish measurement segment (cut by user)
│   │── right_fish.mp4        #   Fish measurement segment (cut by user)
│   │── side_fish.mp4         #   Side ground truth segment
│   └── sync_info.json        #   Synchronization metadata
│
│── calib_frames/             # Generated by: prepare.py extract
│   │── left/
│   │   │── frame_0001.png
│   │   │── frame_0002.png
│   │   └── ...
│   └── right/
│       │── frame_0001.png
│       │── frame_0002.png
│       └── ...
│
│── calib_params.npz          # Generated by: main.py calibrate
└── measurements.json         # Generated by: main.py measure
```

---

## Environment Setup

### Requirements

- Python 3.8+
- FFmpeg (must be in system PATH)

### Installation

```bash
pip install opencv-python numpy scipy
```

Verify FFmpeg is available:

```bash
ffmpeg -version
```

---

## Usage: Step by Step

### Step 0: Recording Protocol

Record a single continuous video on each camera covering both calibration and fish footage in one take:

| Time | Activity |
|------|----------|
| 0:00 | Start all cameras. **Clap hands** clearly (audio sync signal). |
| ~0:30 | Hold checkerboard in front of both cameras. Move to 15-20 different positions/angles. Ensure the full board is visible in **both** cameras simultaneously. |
| ~2:40 | Remove checkerboard. Fish recording begins. |
| ~3:15 | Stop all cameras. |

> **Critical**: Both cameras must use the exact same video mode (resolution, frame rate, focal length). Calibration frames must come from video, not photos, because the Canon R6 III applies a sensor crop in video mode.

### Step 1: Synchronize Videos

Place raw videos in the session folder and run:

```bash
# Two cameras (left + right)
python prepare.py sync --left_video left.MP4 --right_video right.MP4

# Three cameras (left + right + side)
python prepare.py sync --left_video left.MP4 --right_video right.MP4 --side_video side.MOV
```

Output: `synced/left_synced.mp4`, `synced/right_synced.mp4`, `synced/side_synced.mp4`

All synced videos start at the same moment and have the same duration. Same frame number = same point in time.

### Step 2: Cut Segments

View the synced left video to identify where the checkerboard section ends and the fish section begins. Then cut with FFmpeg:

```bash
# Calibration segment (checkerboard portion)
ffmpeg -y -ss 00:00:27 -to 00:02:37 -i synced/left_synced.mp4 -c copy synced/left_calib.mp4
ffmpeg -y -ss 00:00:27 -to 00:02:37 -i synced/right_synced.mp4 -c copy synced/right_calib.mp4

# Fish segment
ffmpeg -y -ss 00:02:37 -i synced/left_synced.mp4 -c copy synced/left_fish.mp4
ffmpeg -y -ss 00:02:37 -i synced/right_synced.mp4 -c copy synced/right_fish.mp4
ffmpeg -y -ss 00:02:37 -i synced/side_synced.mp4 -c copy synced/side_fish.mp4
```

> Adjust the timestamps (`00:00:27`, `00:02:37`) to match your actual recording.

### Step 3: Extract Calibration Frames

```bash
python prepare.py extract --left_video synced/left_calib.mp4 --right_video synced/right_calib.mp4 --output_dir ./calib_frames
```

Extracts 1 frame per second. A 2-minute calibration video yields ~120 frame pairs.

### Step 4: Calibrate

```bash
python main.py calibrate --calib_dir ./calib_frames --square_size 18
```

When prompted, confirm or override the checkerboard parameters (inner corners cols, rows, square size in mm). Add `--show` to visualize detected corners on each image.

**What to check:**
- Stereo RMS reprojection error: **< 1.0 px** (excellent), **< 1.5 px** (acceptable), **> 2.0 px** (recalibrate)
- Left and right focal lengths should differ by **< 1%**
- At least **10+ valid pairs** used

Output: `calib_params.npz`

### Step 5: Verify Rectification

```bash
python main.py verify --calib_file calib_params.npz \
    --left_img calib_frames/left/frame_0060.png \
    --right_img calib_frames/right/frame_0060.png
```

A window shows left and right images side by side with green horizontal lines. The same feature (checkerboard corner, fish eye) must lie on the same green line in both images. Press any key to close.

### Step 6: Measure Fish

```bash
python main.py measure --left_video synced/left_fish.mp4 \
    --right_video synced/right_fish.mp4 \
    --calib_file calib_params.npz
```

Two windows open: **Left** and **Right**.

**Interaction flow:**
1. Navigate to a frame with a clear side-view fish
2. In the **Left** window: click the **mouth tip**, then the **caudal base**
3. Yellow epipolar guide lines appear on the Right window
4. In the **Right** window: click the **same fish's mouth tip**, then **caudal base** (on or near the yellow lines)
5. The measured length prints in the terminal
6. Press **R** to reset and measure another fish

**Keyboard controls:**

| Key | Action |
|-----|--------|
| `A` / `D` | Previous / next frame |
| `W` / `S` | Jump 10 frames back / forward |
| `Q` / `E` | Jump 100 frames back / forward |
| `R` | Reset clicked points |
| `Esc` | Quit and save all measurements |

Output: `measurements.json` with 3D coordinates, disparities, depths, and lengths for every measured fish.

---

## Output Format

```json
[
  {
    "frame": 450,
    "length_mm": 40.6,
    "mouth_L": [2633.6, 1324.8],
    "mouth_R": [1644.8, 1324.8],
    "tail_L": [2848.0, 1356.8],
    "tail_R": [1868.8, 1363.2],
    "disparity_mouth": 988.80,
    "disparity_tail": 979.20,
    "depth_mouth_mm": 761.8,
    "depth_tail_mm": 769.3,
    "mouth_3d": [91.7, 29.8, 761.8],
    "tail_3d": [131.2, 35.9, 769.3]
  }
]
```

---

## Notes

- **Calibrate in the same video mode as measurement.** Photo mode and video mode use different sensor crops on the Canon R6 III.
- **Recalibrate if cameras are moved.** Even slight bumps invalidate the calibration.
- **Air calibration** is used by default. This introduces a small systematic bias (estimated 3-8%) when measuring fish in water due to refraction through glass. For higher accuracy, calibrate with the checkerboard submerged in the tank.
- **Only measure Class 0 and Class 1 fish** (lateral side views). Head-on or severely bent fish cannot be reliably measured by any stereo system.
